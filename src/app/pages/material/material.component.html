<!-- src/app/pages/material/material.component.html -->
<!-- Changes:
- For principal dialog, updated select to use principalOptions() instead of allControlModels().
- In details section, added Principal Control Model: {{ getPrincipalLabel(material) }}.
- Updated error messages in ts to show err.error?.message.
-->

<div class="p-4">
    <h2 class="text-2xl font-bold mb-4">Materials Management</h2>

    <p-button label="Create New" icon="pi pi-plus" (click)="openCreateDialog()" class="mb-4"></p-button>

    <p-table [value]="materials()" responsiveLayout="scroll" [paginator]="true" [rows]="10">
        <ng-template pTemplate="header">
            <tr>
                <th>ID</th>
                <th>Material Number</th>
                <th>Description</th>
                <th>Type</th>
                <th>Actions</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-material>
            <tr>
                <td>{{ material.id }}</td>
                <td>{{ material.materialNumber }}</td>
                <td>{{ material.description }}</td>
                <td>{{ getTypeLabel(material.materialType) }}</td>
                <td class="flex space-x-2">
                    <p-button icon="pi pi-pencil" (click)="openEditDialog(material)"
                        styleClass="p-button-rounded p-button-success" pTooltip="Edit"></p-button>
                    <p-button icon="pi pi-trash" (click)="deleteMaterial(material)"
                        styleClass="p-button-rounded p-button-danger" pTooltip="Delete"></p-button>
                    <p-button icon="pi pi-tag" (click)="openClassifyDialog(material)"
                        styleClass="p-button-rounded p-button-info" pTooltip="Classify"></p-button>
                    <p-button icon="pi pi-cog" (click)="openPrincipalDialog(material)"
                        styleClass="p-button-rounded p-button-warning"
                        pTooltip="Set Principal Control Model"></p-button>
                    <p-button icon="pi pi-plus-circle" (click)="openControlModelDialog(material, true)"
                        styleClass="p-button-rounded p-button-info" pTooltip="Assign Control Model"></p-button>
                    <p-button icon="pi pi-minus-circle" (click)="openControlModelDialog(material, false)"
                        styleClass="p-button-rounded p-button-warning" pTooltip="Remove Control Model"></p-button>
                </td>
            </tr>
            <tr *ngIf="selectedMaterial()?.id === material.id">
                <td colspan="5">
                    <div class="p-2 bg-gray-100 rounded-md">
                        <h3 class="text-lg font-semibold">Details:</h3>
                        <p>Base UOM: {{ material.baseUnitOfMeasure }}</p>
                        <p>Group: {{ material.materialGroup }}</p>
                        <!-- Add more details as needed -->
                        <h3 class="text-lg font-semibold">Classifications:</h3>
                        <ul class="list-disc pl-5">
                            <li *ngFor="let cls of material.classifications">
                                {{ cls.className }}
                            </li>
                        </ul>
                        <h3 class="text-lg font-semibold">Control Models:</h3>
                        <ul class="list-disc pl-5">
                            <li *ngFor="let cm of material.controlModels">
                                {{ cm.description }} (Principal: {{ cm.isPrincipal ? 'Yes' : 'No' }})
                            </li>
                        </ul>
                        <p>Principal Control Model: {{ getPrincipalLabel(material) }}</p>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Form Dialog for Create/Edit (Upgraded with All Fields) -->
    <p-dialog [header]="isEditMode() ? 'Edit Material' : 'Create Material'" [visible]="displayFormDialog()"
        (visibleChange)="displayFormDialog.set($event)" [modal]="true" [style]="{width: '50vw'}">
        <form [formGroup]="materialForm" class="grid grid-cols-2 gap-4">
            <div>
                <label for="materialNumber" class="block mb-1 font-medium">Material Number</label>
                <input type="text" id="materialNumber" formControlName="materialNumber"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="materialType" class="block mb-1 font-medium">Material Type</label>
                <select id="materialType" formControlName="materialType" class="w-full rounded-md border p-2">
                    <option *ngFor="let opt of materialTypeOptions" [ngValue]="opt.value">{{ opt.label }}</option>
                </select>
            </div>
            <div>
                <label for="description" class="block mb-1 font-medium">Description</label>
                <input type="text" id="description" formControlName="description"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="baseUnitOfMeasure" class="block mb-1 font-medium">Base UOM</label>
                <input type="text" id="baseUnitOfMeasure" formControlName="baseUnitOfMeasure"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="materialGroup" class="block mb-1 font-medium">Material Group</label>
                <input type="text" id="materialGroup" formControlName="materialGroup"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="division" class="block mb-1 font-medium">Division</label>
                <input type="text" id="division" formControlName="division" class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="batchManagement" class="block mb-1 font-medium">Batch Management</label>
                <p-checkbox id="batchManagement" formControlName="batchManagement" [binary]="true"></p-checkbox>
            </div>
            <div>
                <label for="serialNumberManagement" class="block mb-1 font-medium">Serial Number Management</label>
                <p-checkbox id="serialNumberManagement" formControlName="serialNumberManagement"
                    [binary]="true"></p-checkbox>
            </div>
            <div>
                <label for="taxClassification" class="block mb-1 font-medium">Tax Classification</label>
                <input type="text" id="taxClassification" formControlName="taxClassification"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="industrySector" class="block mb-1 font-medium">Industry Sector</label>
                <input type="text" id="industrySector" formControlName="industrySector"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="oldMaterialNumber" class="block mb-1 font-medium">Old Material Number</label>
                <input type="text" id="oldMaterialNumber" formControlName="oldMaterialNumber"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="materialHierarchy" class="block mb-1 font-medium">Material Hierarchy</label>
                <input type="text" id="materialHierarchy" formControlName="materialHierarchy"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="materialStatus" class="block mb-1 font-medium">Material Status</label>
                <input type="text" id="materialStatus" formControlName="materialStatus"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="procurementType" class="block mb-1 font-medium">Procurement Type</label>
                <input type="text" id="procurementType" formControlName="procurementType"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="mrpType" class="block mb-1 font-medium">MRP Type</label>
                <input type="text" id="mrpType" formControlName="mrpType" class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="mrpController" class="block mb-1 font-medium">MRP Controller</label>
                <input type="text" id="mrpController" formControlName="mrpController"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="lotSize" class="block mb-1 font-medium">Lot Size</label>
                <input type="text" id="lotSize" formControlName="lotSize" class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="purchasingGroup" class="block mb-1 font-medium">Purchasing Group</label>
                <input type="text" id="purchasingGroup" formControlName="purchasingGroup"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="purchasingValueKey" class="block mb-1 font-medium">Purchasing Value Key</label>
                <input type="text" id="purchasingValueKey" formControlName="purchasingValueKey"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="accountAssignmentGroup" class="block mb-1 font-medium">Account Assignment Group</label>
                <input type="text" id="accountAssignmentGroup" formControlName="accountAssignmentGroup"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="valuationClass" class="block mb-1 font-medium">Valuation Class</label>
                <input type="text" id="valuationClass" formControlName="valuationClass"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="standardPrice" class="block mb-1 font-medium">Standard Price</label>
                <input type="number" id="standardPrice" formControlName="standardPrice"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="movingAveragePrice" class="block mb-1 font-medium">Moving Average Price</label>
                <input type="number" id="movingAveragePrice" formControlName="movingAveragePrice"
                    class="w-full rounded-md border p-2" />
            </div>
            <div class="col-span-2">
                <label for="taxData" class="block mb-1 font-medium">Tax Data</label>
                <textarea id="taxData" formControlName="taxData" class="w-full rounded-md border p-2"
                    rows="2"></textarea>
            </div>
            <div class="col-span-2">
                <label for="classificationData" class="block mb-1 font-medium">Classification Data</label>
                <textarea id="classificationData" formControlName="classificationData"
                    class="w-full rounded-md border p-2" rows="2"></textarea>
            </div>
        </form>
        <ng-template pTemplate="footer">
            <p-button label="Save" icon="pi pi-check" (click)="saveMaterial()" styleClass="p-button-success"></p-button>
            <p-button label="Cancel" icon="pi pi-times" (click)="displayFormDialog.set(false)"
                styleClass="p-button-secondary"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Classify Dialog -->
    <p-dialog header="Classify Material" [visible]="displayClassifyDialog()"
        (visibleChange)="displayClassifyDialog.set($event)" [modal]="true" [style]="{width: '30vw'}">
        <div>
            <label for="classificationId" class="block mb-1 font-medium">Classification</label>
            <select id="classificationId" [ngModel]="selectedClassificationId()"
                (ngModelChange)="selectedClassificationId.set($event)" class="w-full rounded-md border p-2">
                <option value="0" disabled selected>Select a classification</option>
                <option *ngFor="let cls of allClassifications()" [value]="cls.id">{{ cls.className }}</option>
            </select>
        </div>
        <ng-template pTemplate="footer">
            <p-button label="Classify" icon="pi pi-check" (click)="classifyMaterial()"
                styleClass="p-button-success"></p-button>
            <p-button label="Cancel" icon="pi pi-times" (click)="displayClassifyDialog.set(false)"
                styleClass="p-button-secondary"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Set Principal Dialog -->
    <p-dialog header="Set Principal Control Model" [visible]="displayPrincipalDialog()"
        (visibleChange)="displayPrincipalDialog.set($event)" [modal]="true" [style]="{width: '30vw'}">
        <div>
            <label for="controlModelId" class="block mb-1 font-medium">Control Model</label>
            <select id="controlModelId" [ngModel]="selectedControlModelId()"
                (ngModelChange)="selectedControlModelId.set($event)" class="w-full rounded-md border p-2">
                <option value="0" disabled selected>Select a control model</option>
                <option *ngFor="let opt of principalOptions()" [value]="opt.value">{{ opt.label }}</option>
            </select>
        </div>
        <ng-template pTemplate="footer">
            <p-button label="Set Principal" icon="pi pi-check" (click)="setPrincipal()"
                styleClass="p-button-success"></p-button>
            <p-button label="Cancel" icon="pi pi-times" (click)="displayPrincipalDialog.set(false)"
                styleClass="p-button-secondary"></p-button>
        </ng-template>
    </p-dialog>

    <!-- New Control Model Dialog for Assign/Remove -->
    <p-dialog [header]="isAssignMode() ? 'Assign Control Model' : 'Remove Control Model'"
        [visible]="displayControlModelDialog()" (visibleChange)="displayControlModelDialog.set($event)" [modal]="true"
        [style]="{width: '30vw'}">
        <div>
            <label for="controlModelIdAssign" class="block mb-1 font-medium">Control Model</label>
            <select id="controlModelIdAssign" [ngModel]="selectedControlModelId()"
                (ngModelChange)="selectedControlModelId.set($event)" class="w-full rounded-md border p-2">
                <option value="0" disabled selected>Select a control model</option>
                <option *ngFor="let opt of isAssignMode() ? controlModelsForAssign() : controlModelsForRemove()"
                    [value]="opt.value">{{ opt.label }}</option>
            </select>
        </div>
        <ng-template pTemplate="footer">
            <p-button label="Submit" icon="pi pi-check" (click)="manageControlModel()"
                styleClass="p-button-success"></p-button>
            <p-button label="Cancel" icon="pi pi-times" (click)="displayControlModelDialog.set(false)"
                styleClass="p-button-secondary"></p-button>
        </ng-template>
    </p-dialog>

    <p-confirmDialog></p-confirmDialog>
    <p-toast></p-toast>
</div>