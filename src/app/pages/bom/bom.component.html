<!-- src/app/pages/bom/bom.component.html -->
<div class="p-4">
    <h2 class="text-2xl font-bold mb-4">BOM Management</h2>

    <p-button label="Create New" icon="pi pi-plus" (click)="openCreateDialog()" class="mb-4"></p-button>

    <p-table [value]="boms()" responsiveLayout="scroll" [paginator]="true" [rows]="10">
        <ng-template pTemplate="header">
            <tr>
                <th>ID</th>
                <th>BOM Number</th>
                <th>Description</th>
                <th>Status</th>
                <th>Principal Material</th>
                <th>Actions</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-bom>
            <tr>
                <td>{{ bom.id }}</td>
                <td>{{ bom.bomNumber }}</td>
                <td>{{ bom.bomDescription }}</td>
                <td>{{ getBOMStatusLabel(bom.bomStatus) }}</td>
                <td>{{ getMaterialLabel(bom.principalMaterial?.id) }}</td>
                <td class="flex space-x-2">
                    <p-button icon="pi pi-pencil" (click)="openEditDialog(bom)"
                        styleClass="p-button-rounded p-button-success" pTooltip="Edit"></p-button>
                    <p-button icon="pi pi-trash" (click)="deleteBOM(bom)" styleClass="p-button-rounded p-button-danger"
                        pTooltip="Delete"></p-button>
                    <p-button icon="pi pi-plus-circle" (click)="openMaterialDialog(bom, true)"
                        styleClass="p-button-rounded p-button-info" pTooltip="Add Material"></p-button>
                    <p-button icon="pi pi-minus-circle" (click)="openMaterialDialog(bom, false)"
                        styleClass="p-button-rounded p-button-warning" pTooltip="Remove Material"></p-button>
                </td>
            </tr>
            <tr *ngIf="selectedBom()?.id === bom.id">
                <td colspan="6">
                    <div class="p-2 bg-gray-100 rounded-md">
                        <h3 class="text-lg font-semibold">Details:</h3>
                        <p>BOM Number: {{ bom.bomNumber }}</p>
                        <p>Description: {{ bom.bomDescription }}</p>
                        <p>Status: {{ getBOMStatusLabel(bom.bomStatus) }}</p>
                        <p>Validity Start: {{ bom.validityStartDate | date }}</p>
                        <p>Validity End: {{ bom.validityEndDate | date }}</p>
                        <p>Base Quantity: {{ bom.baseQuantity }} {{ bom.unitOfMeasure }}</p>
                        <p>Principal Material: {{ getMaterialLabel(bom.principalMaterial?.id) }}</p>
                        <h3 class="text-lg font-semibold">Materials:</h3>
                        <ul class="list-disc pl-5">
                            <li *ngFor="let mat of bom.materials">
                                {{ mat.description }} (ID: {{ mat.id }})
                            </li>
                        </ul>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Form Dialog for Create/Edit -->
    <p-dialog [header]="isEditMode() ? 'Edit BOM' : 'Create BOM'" [visible]="displayFormDialog()"
        (visibleChange)="displayFormDialog.set($event)" [modal]="true" [style]="{width: '50vw'}">
        <form [formGroup]="bomForm" class="grid grid-cols-2 gap-4">
            <div>
                <label for="bomNumber" class="block mb-1 font-medium">BOM Number</label>
                <input type="text" id="bomNumber" formControlName="bomNumber" class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="alternativeBomNumber" class="block mb-1 font-medium">Alternative BOM Number</label>
                <input type="text" id="alternativeBomNumber" formControlName="alternativeBomNumber"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="bomStatus" class="block mb-1 font-medium">Status</label>
                <select id="bomStatus" formControlName="bomStatus" class="w-full rounded-md border p-2">
                    <option *ngFor="let opt of bomStatusOptions" [value]="opt.value">{{ opt.label }}</option>
                </select>
            </div>
            <div>
                <label for="validityStartDate" class="block mb-1 font-medium">Validity Start Date</label>
                <input type="date" id="validityStartDate" formControlName="validityStartDate"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="validityEndDate" class="block mb-1 font-medium">Validity End Date</label>
                <input type="date" id="validityEndDate" formControlName="validityEndDate"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="baseQuantity" class="block mb-1 font-medium">Base Quantity</label>
                <input type="text" id="baseQuantity" formControlName="baseQuantity"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="unitOfMeasure" class="block mb-1 font-medium">Unit of Measure</label>
                <input type="text" id="unitOfMeasure" formControlName="unitOfMeasure"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="bomDescription" class="block mb-1 font-medium">Description</label>
                <input type="text" id="bomDescription" formControlName="bomDescription"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="principalMaterialId" class="block mb-1 font-medium">Principal Material</label>
                <select id="principalMaterialId" formControlName="principalMaterialId"
                    class="w-full rounded-md border p-2">
                    <option value="0" disabled selected>Select a material</option>
                    <option *ngFor="let mat of allMaterials()" [value]="mat.id">{{ mat.description }}</option>
                </select>
            </div>
        </form>
        <ng-template pTemplate="footer">
            <p-button label="Save" icon="pi pi-check" (click)="saveBOM()" styleClass="p-button-success"></p-button>
            <p-button label="Cancel" icon="pi pi-times" (click)="displayFormDialog.set(false)"
                styleClass="p-button-secondary"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Material Dialog for Add/Remove -->
    <p-dialog [header]="isAddMode() ? 'Add Material' : 'Remove Material'" [visible]="displayMaterialDialog()"
        (visibleChange)="displayMaterialDialog.set($event)" [modal]="true" [style]="{width: '30vw'}">
        <div>
            <label for="materialId" class="block mb-1 font-medium">Material</label>
            <select id="materialId" [ngModel]="selectedMaterialId()" (ngModelChange)="selectedMaterialId.set($event)"
                class="w-full rounded-md border p-2">
                <option value="0" disabled selected>Select a material</option>
                <option *ngFor="let opt of isAddMode() ? materialsForAdd() : materialsForRemove()" [value]="opt.value">
                    {{ opt.label }}</option>
            </select>
        </div>
        <ng-template pTemplate="footer">
            <p-button label="Submit" icon="pi pi-check" (click)="manageMaterial()"
                styleClass="p-button-success"></p-button>
            <p-button label="Cancel" icon="pi pi-times" (click)="displayMaterialDialog.set(false)"
                styleClass="p-button-secondary"></p-button>
        </ng-template>
    </p-dialog>

    <p-confirmDialog></p-confirmDialog>
    <p-toast></p-toast>
</div>