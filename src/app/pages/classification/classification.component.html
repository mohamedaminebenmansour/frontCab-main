<!-- src/app/pages/classification/classification.component.html -->

<div class="p-4">
    <h2 class="text-2xl font-bold mb-4">Classifications Management</h2>

    <p-button label="Create New" icon="pi pi-plus" (click)="openCreateDialog()" class="mb-4"></p-button>

    <p-table [value]="classifications()" responsiveLayout="scroll" [paginator]="true" [rows]="10">
        <ng-template pTemplate="header">
            <tr>
                <th>ID</th>
                <th>Class Number</th>
                <th>Class Name</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-classification>
            <tr (click)="toggleDetails(classification)" class="cursor-pointer">
                <td>{{ classification.id }}</td>
                <td>{{ classification.classNumber }}</td>
                <td>{{ classification.className }}</td>
                <td>{{ getStatusLabel(classification.classStatus) }}</td>
                <td class="flex space-x-2">
                    <p-button icon="pi pi-pencil" (click)="openEditDialog(classification); $event.stopPropagation()"
                        styleClass="p-button-rounded p-button-success" pTooltip="Edit"></p-button>
                    <p-button icon="pi pi-trash"
                        (click)="deleteClassification(classification); $event.stopPropagation()"
                        styleClass="p-button-rounded p-button-danger" pTooltip="Delete"></p-button>
                    <p-button icon="pi pi-plus-circle"
                        (click)="openCharDialog(classification, true); $event.stopPropagation()"
                        styleClass="p-button-rounded p-button-info" pTooltip="Assign Characteristic"></p-button>
                    <p-button icon="pi pi-minus-circle"
                        (click)="openCharDialog(classification, false); $event.stopPropagation()"
                        styleClass="p-button-rounded p-button-warning" pTooltip="Remove Characteristic"></p-button>
                </td>
            </tr>
            <tr *ngIf="selectedClassification()?.id === classification.id">
                <td colspan="5">
                    <div class="p-2 bg-gray-100 rounded-md">
                        <h3 class="text-lg font-semibold">Details:</h3>
                        <p>Description: {{ classification.classDescription }}</p>
                        <p>Group: {{ classification.classGroup }}</p>
                        <p>Hierarchy: {{ classification.classHierarchy }}</p>
                        <p>Usage: {{ classification.classUsage }}</p>
                        <p>Authorization Group: {{ classification.classAuthorizationGroup }}</p>
                        <p>Key Date: {{ classification.classKeyDate | date:'yyyy-MM-dd' }}</p>
                        <p>Validity Start: {{ classification.validityStartDate | date:'yyyy-MM-dd' }}</p>
                        <p>Validity End: {{ classification.validityEndDate | date:'yyyy-MM-dd' }}</p>
                        <h3 class="text-lg font-semibold cursor-pointer" (click)="toggleChars()">Characteristics <i
                                class="pi"
                                [ngClass]="{'pi-chevron-down': showChars(), 'pi-chevron-right': !showChars()}"></i></h3>
                        <div *ngIf="showChars()">
                            <p-button label="Create and Assign New Characteristic" icon="pi pi-plus"
                                (click)="openCharEditDialog()" class="mb-2"></p-button>
                            <ul class="list-disc pl-5">
                                <li *ngFor="let char of classification.characteristics"
                                    class="flex items-center justify-between">
                                    <span>{{ char.characteristicNumber }} - {{ char.characteristicName }}</span>
                                    <div class="flex space-x-2">
                                        <p-button icon="pi pi-pencil" (click)="openCharEditDialog(char)"
                                            styleClass="p-button-rounded p-button-info"
                                            pTooltip="Edit Characteristic"></p-button>
                                        <p-button icon="pi pi-trash"
                                            (click)="removeCharacteristicDirect(classification.id, char.id)"
                                            styleClass="p-button-rounded p-button-danger"
                                            pTooltip="Remove Characteristic"></p-button>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Form Dialog for Classification -->
    <p-dialog [header]="isEditMode() ? 'Edit Classification' : 'Create Classification'" [visible]="displayFormDialog()"
        (visibleChange)="displayFormDialog.set($event)" [modal]="true" [style]="{width: '50vw'}">
        <form [formGroup]="classificationForm" class="grid grid-cols-2 gap-4">
            <div>
                <label for="classNumber" class="block mb-1 font-medium">Class Number</label>
                <input type="text" id="classNumber" formControlName="classNumber"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="className" class="block mb-1 font-medium">Class Name</label>
                <input type="text" id="className" formControlName="className" class="w-full rounded-md border p-2" />
            </div>
            <div class="col-span-2">
                <label for="classDescription" class="block mb-1 font-medium">Description</label>
                <textarea id="classDescription" formControlName="classDescription" class="w-full rounded-md border p-2"
                    rows="4"></textarea>
            </div>
            <div>
                <label for="classStatus" class="block mb-1 font-medium">Status</label>
                <select id="classStatus" formControlName="classStatus" class="w-full rounded-md border p-2">
                    <option *ngFor="let opt of classStatusOptions" [value]="opt.value">{{ opt.label }}</option>
                </select>
            </div>
            <div>
                <label for="classGroup" class="block mb-1 font-medium">Group</label>
                <input type="text" id="classGroup" formControlName="classGroup" class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="classHierarchy" class="block mb-1 font-medium">Hierarchy</label>
                <input type="text" id="classHierarchy" formControlName="classHierarchy"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="classUsage" class="block mb-1 font-medium">Usage</label>
                <input type="text" id="classUsage" formControlName="classUsage" class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="classKeyDate" class="block mb-1 font-medium">Key Date</label>
                <input type="date" id="classKeyDate" formControlName="classKeyDate"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="validityStartDate" class="block mb-1 font-medium">Validity Start</label>
                <input type="date" id="validityStartDate" formControlName="validityStartDate"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="validityEndDate" class="block mb-1 font-medium">Validity End</label>
                <input type="date" id="validityEndDate" formControlName="validityEndDate"
                    class="w-full rounded-md border p-2" />
            </div>
            <div>
                <label for="isInherited" class="block mb-1 font-medium">Is Inherited</label>
                <p-checkbox id="isInherited" formControlName="isInherited" [binary]="true"></p-checkbox>
            </div>
            <div>
                <label for="classAuthorizationGroup" class="block mb-1 font-medium">Authorization Group</label>
                <input type="text" id="classAuthorizationGroup" formControlName="classAuthorizationGroup"
                    class="w-full rounded-md border p-2" />
            </div>
        </form>
        <ng-template pTemplate="footer">
            <p-button label="Save" icon="pi pi-check" (click)="saveClassification()"
                styleClass="p-button-success"></p-button>
            <p-button label="Cancel" icon="pi pi-times" (click)="displayFormDialog.set(false)"
                styleClass="p-button-secondary"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Characteristic Assignment/Removal Dialog -->
    <p-dialog [header]="isAssignMode() ? 'Assign Characteristic' : 'Remove Characteristic'"
        [visible]="displayCharDialog()" (visibleChange)="displayCharDialog.set($event)" [modal]="true"
        [style]="{width: '30vw'}">
        <div>
            <label for="charId" class="block mb-1 font-medium">Characteristic</label>
            <select id="charId" [ngModel]="selectedCharId()" (ngModelChange)="selectedCharId.set($event)"
                class="w-full rounded-md border p-2">
                <option value="0" disabled selected>Select a characteristic</option>
                <option *ngFor="let opt of isAssignMode() ? characteristicsForAssign() : characteristicsForRemove()"
                    [value]="opt.value">{{ opt.label }}</option>
            </select>
        </div>
        <ng-template pTemplate="footer">
            <p-button label="Submit" icon="pi pi-check" (click)="manageCharacteristic()"
                styleClass="p-button-success"></p-button>
            <p-button label="Cancel" icon="pi pi-times" (click)="displayCharDialog.set(false)"
                styleClass="p-button-secondary"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Characteristic Edit/Create Dialog -->
    <p-dialog header="{{ isCharEditMode() ? 'Edit Characteristic' : 'New Characteristic' }}"
        [visible]="displayCharEditDialog()" (visibleChange)="displayCharEditDialog.set($event)" [modal]="true"
        [style]="{width: '50vw'}">

        <form [formGroup]="characteristicForm" (ngSubmit)="saveCharacteristic()">
            <div class="grid gap-4 p-fluid">
                <!-- ID (read-only) -->
                <div class="field col-12 md:col-6">
                    <label for="id" class="block text-sm font-medium text-gray-700">ID</label>
                    <input id="id" pInputText formControlName="id" class="w-full border-gray-300 rounded-md shadow-sm"
                        readonly />
                </div>

                <!-- Characteristic Number -->
                <div class="field col-12 md:col-6">
                    <label for="characteristicNumber" class="block text-sm font-medium text-gray-700">Characteristic
                        Number
                        *</label>
                    <input id="characteristicNumber" pInputText formControlName="characteristicNumber"
                        class="w-full border-gray-300 rounded-md shadow-sm p-2" />
                    <small
                        *ngIf="characteristicForm.get('characteristicNumber')?.invalid && characteristicForm.get('characteristicNumber')?.touched"
                        class="text-red-600">
                        Number is required (min 3 chars).
                    </small>
                </div>

                <!-- Characteristic Name -->
                <div class="field col-12 md:col-6">
                    <label for="characteristicName" class="block text-sm font-medium text-gray-700">Characteristic Name
                        *</label>
                    <input id="characteristicName" pInputText formControlName="characteristicName"
                        class="w-full border-gray-300 rounded-md shadow-sm p-2" />
                    <small
                        *ngIf="characteristicForm.get('characteristicName')?.invalid && characteristicForm.get('characteristicName')?.touched"
                        class="text-red-600">
                        Name is required.
                    </small>
                </div>

                <!-- Data Type -->
                <div class="field col-12 md:col-6">
                    <label for="dataType" class="block text-sm font-medium text-gray-700">Data Type *</label>
                    <p-select id="dataType" formControlName="dataType" [options]="dataTypes"
                        placeholder="Select Data Type" class="w-full"></p-select>
                    <small
                        *ngIf="characteristicForm.get('dataType')?.invalid && characteristicForm.get('dataType')?.touched"
                        class="text-red-600">
                        Data Type is required.
                    </small>
                </div>

                <!-- Characteristic Description -->
                <div class="field col-12">
                    <label for="characteristicDescription" class="block text-sm font-medium text-gray-700">Description
                        *</label>
                    <input id="characteristicDescription" pInputText formControlName="characteristicDescription"
                        class="w-full border-gray-300 rounded-md shadow-sm p-2" />
                    <small
                        *ngIf="characteristicForm.get('characteristicDescription')?.invalid && characteristicForm.get('characteristicDescription')?.touched"
                        class="text-red-600">
                        Description is required.
                    </small>
                </div>

                <!-- Value Range -->
                <div class="field col-12 md:col-6">
                    <label for="valueRange" class="block text-sm font-medium text-gray-700">Value Range</label>
                    <input id="valueRange" pInputText formControlName="valueRange"
                        class="w-full border-gray-300 rounded-md shadow-sm p-2" />
                </div>

                <!-- Default Value -->
                <div class="field col-12 md:col-6">
                    <label for="defaultValue" class="block text-sm font-medium text-gray-700">Default Value</label>
                    <input id="defaultValue" pInputText formControlName="defaultValue"
                        class="w-full border-gray-300 rounded-md shadow-sm p-2" />
                </div>

                <!-- Unit of Measure -->
                <div class="field col-12 md:col-6">
                    <label for="unitOfMeasure" class="block text-sm font-medium text-gray-700">Unit of Measure</label>
                    <input id="unitOfMeasure" pInputText formControlName="unitOfMeasure"
                        class="w-full border-gray-300 rounded-md shadow-sm p-2" />
                </div>

                <!-- Is Required -->
                <div class="field col-12 md:col-6 flex items-center gap-2">
                    <p-toggleSwitch formControlName="isRequired"></p-toggleSwitch>
                    <label for="isRequired" class="text-sm font-medium text-gray-700">Required</label>
                </div>

                <!-- Is Single Value -->
                <div class="field col-12 md:col-6 flex items-center gap-2">
                    <p-toggleSwitch formControlName="isSingleValue"></p-toggleSwitch>
                    <label for="isSingleValue" class="text-sm font-medium text-gray-700">Single Value</label>
                </div>

                <!-- Characteristic Group -->
                <div class="field col-12 md:col-6">
                    <label for="characteristicGroup" class="block text-sm font-medium text-gray-700">Characteristic
                        Group
                        *</label>
                    <p-select id="characteristicGroup" formControlName="characteristicGroup"
                        [options]="characteristicGroups" placeholder="Select Group" class="w-full"></p-select>
                    <small
                        *ngIf="characteristicForm.get('characteristicGroup')?.invalid && characteristicForm.get('characteristicGroup')?.touched"
                        class="text-red-600">
                        Group is required.
                    </small>
                </div>

                <!-- Validity Start Date -->
                <div class="field col-12 md:col-6">
                    <label for="validityStartDate" class="block text-sm font-medium text-gray-700">Validity Start Date
                        *</label>
                    <input id="validityStartDate" type="date" formControlName="validityStartDate"
                        class="w-full border-gray-300 rounded-md shadow-sm p-2" />
                    <small
                        *ngIf="characteristicForm.get('validityStartDate')?.invalid && characteristicForm.get('validityStartDate')?.touched"
                        class="text-red-600">
                        Start Date is required.
                    </small>
                </div>

                <!-- Validity End Date -->
                <div class="field col-12 md:col-6">
                    <label for="validityEndDate" class="block text-sm font-medium text-gray-700">Validity End Date
                        *</label>
                    <input id="validityEndDate" type="date" formControlName="validityEndDate"
                        class="w-full border-gray-300 rounded-md shadow-sm p-2" />
                    <small
                        *ngIf="characteristicForm.get('validityEndDate')?.invalid && characteristicForm.get('validityEndDate')?.touched"
                        class="text-red-600">
                        End Date is required.
                    </small>
                </div>

                <!-- Created At (read-only) -->
                <div class="field col-12 md:col-6">
                    <label for="createdAt" class="block text-sm font-medium text-gray-700">Created At</label>
                    <input id="createdAt" pInputText formControlName="createdAt"
                        class="w-full border-gray-300 rounded-md shadow-sm p-2" readonly
                        [value]="characteristicForm.get('createdAt')?.value | date:'short'" />
                </div>

                <!-- Last Updated (read-only) -->
                <div class="field col-12 md:col-6">
                    <label for="lastUpdated" class="block text-sm font-medium text-gray-700">Last Updated</label>
                    <input id="lastUpdated" pInputText formControlName="lastUpdated"
                        class="w-full border-gray-300 rounded-md shadow-sm p-2" readonly
                        [value]="characteristicForm.get('lastUpdated')?.value | date:'short'" />
                </div>
            </div>
        </form>

        <!-- Footer -->
        <ng-template pTemplate="footer">
            <div class="flex justify-end gap-2">
                <p-button label="Cancel" icon="pi pi-times" severity="secondary"
                    (onClick)="displayCharEditDialog.set(false)"></p-button>
                <p-button label="Save" icon="pi pi-check" severity="primary" (onClick)="saveCharacteristic()"
                    [disabled]="characteristicForm.invalid">
                </p-button>
            </div>
        </ng-template>
    </p-dialog>

    <p-confirmDialog></p-confirmDialog>
    <p-toast></p-toast>
</div>